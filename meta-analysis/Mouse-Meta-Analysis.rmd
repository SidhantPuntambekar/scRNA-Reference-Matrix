---
title: "Mouse-Meta-Analysis"
author: "Sidhant Puntambekar"
date: "7/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mouse meta-analysis

This file contains the meta-analysis of the mouseAtlas.rds generated by combining reference matrices from a variety of scRNA-seq datasets from across NCBI GEO and Tabula Muris. 

First, the necessary libraries will be loaded in. They are dplyr (standard dataframe library), Seurat (create Seurat object), patchwork (ggplot library), clustifyr (clustifyr functions), tidyverse (collection of R data science packages), here (reproducibility of results), and clustree (visualizing clustering in hierarchical structure)

```{r Load libraries}
library(dplyr)
library(Seurat)
library(patchwork)
library(clustifyr)
library(tidyverse)
library(here)
library(clustree)
```

## Load Mouse Atlas

The mouse atlas will now be loaded into the local R data section. This will be accomplished with the here library establishing the root of the project and then loading in the mouseAtlas.rds file into the mouseAtlas matrix object. A Seurat object will then be created in order to perform single cell analysis on the mouse atlas. 

```{r Create Seurat Object}
proj_dir <- here()
mouseAtlas <- readRDS(file.path(proj_dir, "atlas", "musMusculus", "mouseAtlas.rds"))

mouseMetaAnalysis <- CreateSeuratObject(counts = mouseAtlas, project = "Mouse-Meta-Analysis", min.cells = 0, min.features = 0)
gc()

#Normalize Data
mouseMetaAnalysis <- NormalizeData(mouseMetaAnalysis, normalization.method = "LogNormalize", scale.factor = 10000)
```

## Preprocessing Workflow

Following the creation of the Seurat object, the standard workflow for annotating cell types will be followed. First we will filter out cells that do not meet any of the standard QC metrics, data normalization and scaling. First we will filter out genes that contain mitochondrial contamination using a percentage feature set and scanning for the ```^mt-``` pattern. All of the lines following help to visualize the QC metrics we are filtering out by (nCounts, nFeatures, percent.mt)

```{r}
#Preprocessing workflow
mouseMetaAnalysis[["percent.mt"]] <- PercentageFeatureSet(mouseMetaAnalysis, pattern = "^mt-")
VlnPlot(mouseMetaAnalysis, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
plot1 <- FeatureScatter(mouseMetaAnalysis, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(mouseMetaAnalysis, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2
```

## Find Variable Features for PCA

In order to run principal component analysis on the data, cells with high gene expression variability compared to the rest of the data will need to be determined. This will help highlight biological signal of cells in further downstream analysis with PCA and uniform manifold approximation and projection (UMAP). The highly variable genes can also be plotted on a variable feature plot showing standard variance against average gene expression.  

```{r Find Variable Features}
#Find Variable Features for PCA
mouseMetaAnalysis <- FindVariableFeatures(mouseMetaAnalysis, selection.method = "mean.var.plot", nfeatures = 2000)
top10 <- head(VariableFeatures(mouseMetaAnalysis), 10)
plot1 <- VariableFeaturePlot(mouseMetaAnalysis)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
```


## Linear dimension reduction and PCA

Once the variable features have been highlighted, the data can now be reduced into two dimensions from a large number of dimensions through principal component analysis. First, the data must be "scaled" in which a linear transformation shifts the expression of each gene so that the mean expression across cells is zero and that the variance across each cell is one. This should help highly expressed genes not to dominate the data. 

Next, PCA will occur which will scale the data down into two dimensions. The results can be visualized through heat maps and scatter plots. 

```{r Linear dimension reduction and PCA}
all.genes <- rownames(mouseMetaAnalysis)
mouseMetaAnalysis <- ScaleData(mouseMetaAnalysis, features = all.genes)
mouseMetaAnalysis <- RunPCA(mouseMetaAnalysis,
                            features = all.genes,
                            npcs = ncol(mouseMetaAnalysis) - 1)
print(mouseMetaAnalysis[["pca"]], dims = 1:5, nfeatures = 5)
VizDimLoadings(mouseMetaAnalysis, dims = 1:2, reduction = "pca")
DimPlot(mouseMetaAnalysis, reduction = "pca")
DimHeatmap(mouseMetaAnalysis, dims = 1, cells = 500, balanced = TRUE)
DimHeatmap(mouseMetaAnalysis, dims = 1:15, cells = 500, balanced = TRUE)
```

## Determine dimensionality

Following PCA, the number of PCs or clusters that are needed to fully represent the data on a UMAP need to be determined. Many scRNA-seq datasets contain technical noise in the various clusters and the number of clusters needed to represent the dataset must be determined. In this analysis, jack straw plots and a slightly more heuristic elbow plot will be used to determine the accurate number of clusters for UMAP analysis. 

```{r Determine dimensionality}
#Determine dimensionality
mouseMetaAnalysis <- JackStraw(mouseMetaAnalysis, num.replicate = 100)
mouseMetaAnalysis <- ScoreJackStraw(mouseMetaAnalysis, dims = 1:20)
JackStrawPlot(mouseMetaAnalysis, dims = 1:15)
ElbowPlot(mouseMetaAnalysis)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
